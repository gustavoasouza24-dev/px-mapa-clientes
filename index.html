
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Clientes — Filtros + Raio + Export + Progresso</title>

  <!-- CSS (tags corretas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
          height:100vh; display:grid; grid-template-rows:auto 1fr }
    header{ display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center; padding:10px 12px;
            background:var(--panel); border-bottom:1px solid var(--border) }
    .group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .panel{ display:flex; gap:12px; flex-wrap:wrap }
    .filter-box{ border:1px solid var(--border); border-radius:8px; padding:8px; background:#0b1220;
                 max-height:160px; overflow:auto; min-width:220px }
    .filter-title{ font-weight:600; margin-bottom:6px }
    .filter-item{ display:flex; align-items:center; gap:8px; padding:2px 0 }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--border);
           background:#0b1220; font-size:12px; white-space:nowrap }
    .btn{ background:#111827; border:1px solid var(--border); color:var(--text); border-radius:8px; padding:6px 10px; cursor:pointer }
    .btn:hover{ border-color:#374151 }
    .btn-primary{ background:var(--accent); border-color:#16a34a; color:#0b1220 }
    .count{ color:var(--muted); font-size:13px }
    #map{ width:100%; height:calc(100vh - 188px) }
    .status-dot{ width:10px; height:10px; border-radius:50%; border:1px solid rgba(255,255,255,.5); display:inline-block }
    details summary{ cursor:pointer }

    /* Progresso */
    #progress{ width:280px; height:10px; background:#0b1220; border:1px solid var(--border);
               border-radius:999px; overflow:hidden }
    #bar{ height:100%; width:0; background:var(--accent) }

    /* Raio */
    .radius-box{ border:1px solid var(--border); border-radius:8px; padding:8px; background:#0b1220;
                 display:flex; gap:8px; align-items:center }
    .radius-stat{ color:#93c5fd }
  </style>
</head>

<body>
  <header>
    <div class="group">
      <label class="btn" for="fileInput">Carregar Base (.xlsx/.csv)</label>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
      <button class="btn" id="resetBtn">Resetar filtros</button>

      <div id="progress" title="Progresso da geocodificação"><div id="bar"></div></div>
      <span class="count" id="geoStats">Aguardando arquivo…</span>
      <span class="count" id="dataInfo">Nenhum arquivo carregado</span>
      <span class="count" id="countInfo">0 clientes visíveis</span>

      <button class="btn-primary btn" id="exportCsvBtn" disabled>Baixar CSV (lat/lng)</button>
      <button class="btn-primary btn" id="exportXlsxBtn" disabled>Baixar Excel (lat/lng)</button>
    </div>

    <div class="panel">
      <div class="filter-box">
        <div class="filter-title">Cavaleiros (Time)</div>
        <label class="chip"><input type="checkbox" id="selAllCavaleiro" checked> Selecionar tudo</label>
        <div id="listCavaleiro"></div>
      </div>
      <div class="filter-box">
        <div class="filter-title">Classificação</div>
        <label class="chip"><input type="checkbox" id="selAllClass" checked> Selecionar tudo</label>
        <div id="listClass"></div>
      </div>
      <div class="filter-box">
        <div class="filter-title">Status do cliente</div>
        <label class="chip"><input type="checkbox" id="selAllStatus" checked> Selecionar tudo</label>
        <div id="listStatus"></div>
      </div>
    </div>

    <div class="group">
      <div class="radius-box">
        <strong>Raio</strong>
        <label>Centro:</label>
        <select id="radiusCenter">
          <option value="joinville">Joinville (SC)</option>
          <option value="mapClick">Definir por clique no mapa</option>
        </select>
        <label>Km:</label>
        <input type="number" id="radiusKm" min="1" max="2000" step="10" value="400" style="width:80px" />
        <button class="btn" id="toggleCircleBtn">Mostrar raio</button>
        <label class="chip"><input type="checkbox" id="applyRadiusFilter"> Filtrar por raio</label>
        <span class="radius-stat" id="radiusInfo"></span>
      </div>

      <details>
        <summary class="btn">Legenda (Status)</summary>
        <div id="legend" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </details>
    </div>
  </header>

  <main><div id="map"></div></main>

  <!-- JS (tags corretas) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    /* ===== CONFIG DE AUTOCARGA ===== */
    let AUTO_LOAD_URL    = 'clientes_latlng.csv';   // está na raiz do repo
    let AUTO_LOAD_FORMAT = 'csv';                    // formatos suportados: 'csv' | 'xlsx' | 'json'

    // (Opcional) config.json na raiz para trocar o arquivo sem editar o HTML
    fetch('config.json' + cacheBust())
      .then(r => r.ok ? r.json() : null)
      .then(cfg => { if (cfg?.dataUrl) { AUTO_LOAD_URL = cfg.dataUrl; AUTO_LOAD_FORMAT = cfg.format || 'csv'; } })
      .catch(() => null);

    /* ===== Mapa base ===== */
    const NULL_CAVALEIRO='Vazio', NULL_CLASS='Vazio', NULL_STATUS='Sem status';
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contribuidores'
    }).addTo(map);
    map.setView([-26.3049,-48.8487],6); // Joinville
    const clusters=L.markerClusterGroup(); map.addLayer(clusters);

    /* ===== Elementos ===== */
    const fileInputEl=document.getElementById('fileInput');
    const resetBtn=document.getElementById('resetBtn');
    const dataInfoEl=document.getElementById('dataInfo');
    const countInfoEl=document.getElementById('countInfo');
    const legendEl=document.getElementById('legend');
    const geoStatsEl=document.getElementById('geoStats');
    const barEl=document.getElementById('bar');
    const exportCsvBtn=document.getElementById('exportCsvBtn');
    const exportXlsxBtn=document.getElementById('exportXlsxBtn');

    const selAllCavaleiroEl=document.getElementById('selAllCavaleiro');
    const selAllClassEl=document.getElementById('selAllClass');
    const selAllStatusEl=document.getElementById('selAllStatus');
    const listCavaleiroEl=document.getElementById('listCavaleiro');
    const listClassEl=document.getElementById('listClass');
    const listStatusEl=document.getElementById('listStatus');

    /* ===== Raio ===== */
    const radiusCenterEl=document.getElementById('radiusCenter');
    const radiusKmEl=document.getElementById('radiusKm');
    const toggleCircleBtn=document.getElementById('toggleCircleBtn');
    const applyRadiusFilterEl=document.getElementById('applyRadiusFilter');
    const radiusInfoEl=document.getElementById('radiusInfo');

    /* ===== Utils ===== */
    function colorForStatus(status){
      const s=(status||NULL_STATUS).toString();
      let h=0; for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h);
      const hue=Math.abs(h)%360; return `hsl(${hue},70%,50%)`;
    }
    const norm=v=> (v==null? '' : String(v).trim());
    const escapeHtml=str=> String(str).replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    let points=[]; let uniqueCavaleiros=new Set(), uniqueClasses=new Set(), uniqueStatuses=new Set();
    let selCavaleiros=new Set(), selClasses=new Set(), selStatuses=new Set();
    let augmentedRows=[];

    const radiusLayer=L.layerGroup().addTo(map);
    let circle=null; let centerMarker=null; let centerLatLng=L.latLng(-26.3049, -48.8487);
    let circleVisible=false; let centerByClick=false;

    const GEO_CACHE_KEY='geo_cache_v41';
    const geoCache=JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||'{}');

    async function geocodeCityUF(cidade, uf){
      const key=`${cidade}|${uf}`; if(geoCache[key]) return geoCache[key];
      const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade+', '+uf+', Brasil')}`;
      await new Promise(res=>setTimeout(res,1100)); // ~1req/s
      const resp=await fetch(url,{headers:{'Accept-Language':'pt-BR'}});
      if(!resp.ok){ geoCache[key]=null; localStorage.setItem(GEO_CACHE_KEY,JSON.stringify(geoCache)); return null; }
      const json=await resp.json(); let lat=null, lon=null;
