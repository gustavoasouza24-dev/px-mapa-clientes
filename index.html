
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Clientes — Filtros + Raio + Export + Progresso</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root{--bg:#0f172a;--panel:#111827;--border:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;height:100vh;display:grid;grid-template-rows:auto 1fr}
    header{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
    .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .panel{display:flex;gap:12px;flex-wrap:wrap}
    .filter-box{border:1px solid var(--border);border-radius:8px;padding:8px;background:#0b1220;max-height:160px;overflow:auto;min-width:220px}
    .filter-title{font-weight:600;margin-bottom:6px}
    .filter-item{display:flex;align-items:center;gap:8px;padding:2px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1220;font-size:12px;white-space:nowrap}
    .btn{background:#111827;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:#374151}
    .btn-primary{background:var(--accent);border-color:#16a34a;color:#0b1220}
    .count{color:var(--muted);font-size:13px}
    #map{width:100%;height:calc(100vh - 188px)}
    .status-dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(255,255,255,.5);display:inline-block}
    details summary{cursor:pointer}
    #progress{width:280px;height:10px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    #bar{height:100%;width:0;background:var(--accent)}
    .radius-box{border:1px solid var(--border);border-radius:8px;padding:8px;background:#0b1220;display:flex;gap:8px;align-items:center}
    .radius-stat{color:#93c5fd}
  </style>
</head>
<body>
  <header>
    <div class="group">
      <label class="btn" for="fileInput">Carregar Base (.xlsx/.csv)</label>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
      <button class="btn" id="resetBtn">Resetar filtros</button>
      <div id="progress" title="Progresso da geocodificação"><div id="bar"></div></div>
      <span class="count" id="geoStats">Aguardando arquivo…</span>
      <span class="count" id="dataInfo">Nenhum arquivo carregado</span>
      <span class="count" id="countInfo">0 clientes visíveis</span>
      <button class="btn-primary btn" id="exportCsvBtn" disabled>Baixar CSV (lat/lng)</button>
      <button class="btn-primary btn" id="exportXlsxBtn" disabled>Baixar Excel (lat/lng)</button>
    </div>
    <div class="panel">
      <div class="filter-box">
        <div class="filter-title">Cavaleiros (Time)</div>
        <label class="chip"><input type="checkbox" id="selAllCavaleiro" checked> Selecionar tudo</label>
        <div id="listCavaleiro"></div>
      </div>
      <div class="filter-box">
        <div class="filter-title">Classificação</div>
        <label class="chip"><input type="checkbox" id="selAllClass" checked> Selecionar tudo</label>
        <div id="listClass"></div>
      </div>
      <div class="filter-box">
        <div class="filter-title">Status do cliente</div>
        <label class="chip"><input type="checkbox" id="selAllStatus" checked> Selecionar tudo</label>
        <div id="listStatus"></div>
      </div>
    </div>
    <div class="group">
      <div class="radius-box">
        <strong>Raio</strong>
        <label>Centro:</label>
        <select id="radiusCenter">
          <option value="joinville">Joinville (SC)</option>
          <option value="mapClick">Definir por clique no mapa</option>
        </select>
        <label>Km:</label>
        <input type="number" id="radiusKm" min="1" max="2000" step="10" value="400" style="width:80px" />
        <button class="btn" id="toggleCircleBtn">Mostrar raio</button>
        <label class="chip"><input type="checkbox" id="applyRadiusFilter"> Filtrar por raio</label>
        <span class="radius-stat" id="radiusInfo"></span>
      </div>
      <details>
        <summary class="btn">Legenda (Status)</summary>
        <div id="legend" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </details>
    </div>
  </header>
  <main><div id="map"></div></main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const NULL_CAVALEIRO='Vazio', NULL_CLASS='Vazio', NULL_STATUS='Sem status';
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contribuidores'}).addTo(map);
    map.setView([-26.3049,-48.8487],6);
    const clusters=L.markerClusterGroup(); map.addLayer(clusters);

    const fileInputEl=document.getElementById('fileInput');
    const resetBtn=document.getElementById('resetBtn');
    const dataInfoEl=document.getElementById('dataInfo');
    const countInfoEl=document.getElementById('countInfo');
    const legendEl=document.getElementById('legend');
    const geoStatsEl=document.getElementById('geoStats');
    const barEl=document.getElementById('bar');
    const exportCsvBtn=document.getElementById('exportCsvBtn');
    const exportXlsxBtn=document.getElementById('exportXlsxBtn');

    const selAllCavaleiroEl=document.getElementById('selAllCavaleiro');
    const selAllClassEl=document.getElementById('selAllClass');
    const selAllStatusEl=document.getElementById('selAllStatus');
    const listCavaleiroEl=document.getElementById('listCavaleiro');
    const listClassEl=document.getElementById('listClass');
    const listStatusEl=document.getElementById('listStatus');

    // Raio
    const radiusCenterEl=document.getElementById('radiusCenter');
    const radiusKmEl=document.getElementById('radiusKm');
    const toggleCircleBtn=document.getElementById('toggleCircleBtn');
    const applyRadiusFilterEl=document.getElementById('applyRadiusFilter');
    const radiusInfoEl=document.getElementById('radiusInfo');

    function colorForStatus(status){ const s=(status||NULL_STATUS).toString(); let h=0; for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h); const hue=Math.abs(h)%360; return `hsl(${hue},70%,50%)`; }
    const norm=v=> (v==null? '' : String(v).trim());
    const escapeHtml=str=> String(str).replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));

    let points=[]; let uniqueCavaleiros=new Set(), uniqueClasses=new Set(), uniqueStatuses=new Set();
    let selCavaleiros=new Set(), selClasses=new Set(), selStatuses=new Set();
    let augmentedRows=[];

    const radiusLayer=L.layerGroup().addTo(map);
    let circle=null; let centerMarker=null; let centerLatLng=L.latLng(-26.3049, -48.8487);
    let circleVisible=false; let centerByClick=false;

    const GEO_CACHE_KEY='geo_cache_v41';
    const geoCache=JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||'{}');

    async function geocodeCityUF(cidade, uf){
      const key=`${cidade}|${uf}`; if(geoCache[key]) return geoCache[key];
      const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade+', '+uf+', Brasil')}`;
      // ~1 req/s
      await new Promise(res=>setTimeout(res,1100));
      const resp=await fetch(url,{headers:{'Accept-Language':'pt-BR'}});
      if(!resp.ok){ geoCache[key]=null; localStorage.setItem(GEO_CACHE_KEY,JSON.stringify(geoCache)); return null; }
      const json=await resp.json(); let lat=null, lon=null;
      if(Array.isArray(json)&&json.length>0){ lat=parseFloat(json[0].lat); lon=parseFloat(json[0].lon); }
      const val=(lat&&lon)? {lat,lon} : null; geoCache[key]=val; localStorage.setItem(GEO_CACHE_KEY,JSON.stringify(geoCache)); return val;
    }

    function renderLegend(){ legendEl.innerHTML=''; Array.from(uniqueStatuses).sort().forEach(v=>{ const chip=document.createElement('span'); chip.className='chip'; const dot=document.createElement('span'); dot.className='status-dot'; dot.style.background=colorForStatus(v); chip.appendChild(dot); chip.appendChild(document.createTextNode(v)); legendEl.appendChild(chip); }); }

    function renderFilterLists(){
      listCavaleiroEl.innerHTML=''; Array.from(uniqueCavaleiros).sort().forEach(v=>{ const lbl=document.createElement('label'); lbl.className='filter-item'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=true; cb.onchange=onCavaleiroToggle; lbl.appendChild(cb); lbl.appendChild(document.createTextNode(v)); listCavaleiroEl.appendChild(lbl); }); selAllCavaleiroEl.checked=true;
      listClassEl.innerHTML=''; Array.from(uniqueClasses).sort().forEach(v=>{ const lbl=document.createElement('label'); lbl.className='filter-item'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=true; cb.onchange=onClassToggle; lbl.appendChild(cb); lbl.appendChild(document.createTextNode(v)); listClassEl.appendChild(lbl); }); selAllClassEl.checked=true;
      listStatusEl.innerHTML=''; Array.from(uniqueStatuses).sort().forEach(v=>{ const lbl=document.createElement('label'); lbl.className='filter-item'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=true; cb.onchange=onStatusToggle; const dot=document.createElement('span'); dot.className='status-dot'; dot.style.background=colorForStatus(v); lbl.appendChild(cb); lbl.appendChild(dot); lbl.appendChild(document.createTextNode(v)); listStatusEl.appendChild(lbl); }); selAllStatusEl.checked=true;
      selAllCavaleiroEl.onchange=()=> setAll(listCavaleiroEl, selCavaleiros, uniqueCavaleiros, selAllCavaleiroEl.checked);
      selAllClassEl.onchange=()=> setAll(listClassEl, selClasses, uniqueClasses, selAllClassEl.checked);
      selAllStatusEl.onchange=()=> setAll(listStatusEl, selStatuses, uniqueStatuses, selAllStatusEl.checked);
    }

    function setAll(container, selSet, uniq, checkAll){ const inputs=container.querySelectorAll('input[type="checkbox"]'); inputs.forEach(cb=>cb.checked=checkAll); selSet.clear(); if(checkAll) uniq.forEach(v=> selSet.add(v)); updateMarkers(true); }
    function onCavaleiroToggle(e){ const v=e.target.value; if(e.target.checked) selCavaleiros.add(v); else selCavaleiros.delete(v); selAllCavaleiroEl.checked= selCavaleiros.size===uniqueCavaleiros.size; updateMarkers(); }
    function onClassToggle(e){ const v=e.target.value; if(e.target.checked) selClasses.add(v); else selClasses.delete(v); selAllClassEl.checked= selClasses.size===uniqueClasses.size; updateMarkers(); }
    function onStatusToggle(e){ const v=e.target.value; if(e.target.checked) selStatuses.add(v); else selStatuses.delete(v); selAllStatusEl.checked= selStatuses.size===uniqueStatuses.size; updateMarkers(); }

    // Haversine (km)
    function haversineKm(a, b){ const R=6371; const toRad=deg=>deg*Math.PI/180; const dLat=toRad(b.lat-a.lat); const dLng=toRad(b.lng-a.lng); const lat1=toRad(a.lat), lat2=toRad(b.lat); const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
    function updateRadiusUI(){ if(!circleVisible){ radiusInfoEl.textContent=''; return; } const km=parseFloat(radiusKmEl.value)||400; const count=points.filter(p=> withinRadius(p)).length; radiusInfoEl.textContent = `${km} km | ${count} cliente${count===1?'':'s'} no raio`; }
    function withinRadius(p){ if(!circleVisible || !centerLatLng) return true; const km=parseFloat(radiusKmEl.value)||400; const d = haversineKm({lat:centerLatLng.lat,lng:centerLatLng.lng},{lat:p.lat,lng:p.lng}); return d <= km; }
    function drawCircle(){ radiusLayer.clearLayers(); const km=parseFloat(radiusKmEl.value)||400; circle = L.circle(centerLatLng, { radius: km*1000, color:'#22c55e', weight:2, fillColor:'#22c55e', fillOpacity:0.08 }); centerMarker = L.marker(centerLatLng, { draggable:true }).on('dragend', e=>{ centerLatLng = e.target.getLatLng(); updateRadiusUI(); updateMarkers(); drawCircle(); }); radiusLayer.addLayer(circle); radiusLayer.addLayer(centerMarker); }
    toggleCircleBtn.addEventListener('click', ()=>{ circleVisible = !circleVisible; toggleCircleBtn.textContent = circleVisible? 'Ocultar raio' : 'Mostrar raio'; if(circleVisible){ drawCircle(); updateRadiusUI(); } else { radiusLayer.clearLayers(); updateMarkers(); } });
    radiusKmEl.addEventListener('change', ()=>{ if(circleVisible){ drawCircle(); updateRadiusUI(); updateMarkers(); } });
    applyRadiusFilterEl.addEventListener('change', ()=> updateMarkers());
    radiusCenterEl.addEventListener('change', ()=>{ const val=radiusCenterEl.value; if(val==='joinville'){ centerByClick=false; centerLatLng=L.latLng(-26.3049,-48.8487); if(circleVisible){ drawCircle(); updateRadiusUI(); updateMarkers(); } } else { centerByClick=true; alert('Clique em qualquer ponto do mapa para definir o centro do raio.'); } });
    map.on('click', (e)=>{ if(centerByClick){ centerLatLng = e.latlng; centerByClick=false; radiusCenterEl.value='mapClick'; if(circleVisible){ drawCircle(); updateRadiusUI(); updateMarkers(); } } });

    function updateMarkers(fit=false){ clusters.clearLayers(); let count=0; const latlngs=[]; points.forEach(p=>{ if(!selCavaleiros.has(p.cavaleiro)) return; if(!selClasses.has(p.classificacao)) return; if(!selStatuses.has(p.status)) return; if(applyRadiusFilterEl.checked && circleVisible && !withinRadius(p)) return; const m=L.circleMarker([p.lat,p.lng],{radius:7,color:colorForStatus(p.status),fillColor:colorForStatus(p.status),weight:2,fillOpacity:0.7}).bindPopup(`<strong>${escapeHtml(p.nome||'Cliente')}</strong><br>Time: ${escapeHtml(p.cavaleiro)}<br>Classificação: ${escapeHtml(p.classificacao)}<br>Status: ${escapeHtml(p.status)}<br>Cidade/UF: ${escapeHtml(p.cidade)} / ${escapeHtml(p.uf)}`); clusters.addLayer(m); count++; latlngs.push([p.lat,p.lng]); }); countInfoEl.textContent=`${count} cliente${count===1?'':'s'} visível${count===1?'':'eis'}`; if(fit&&latlngs.length>0){ const b=L.latLngBounds(latlngs); map.fitBounds(b.pad(0.2)); } updateRadiusUI(); }

    fileInputEl.addEventListener('change', async (evt)=>{
      const file=evt.target.files[0]; if(!file) return; dataInfoEl.textContent=`Carregando: ${file.name}...`;
      const name=file.name.toLowerCase(); try{
        const rows = name.endsWith('.csv')? await parseCSV(file) : await parseExcel(file);
        dataInfoEl.textContent=`${rows.length} linhas carregadas`;
        await prepareAndGeocodeIncremental(rows, file.name);
      }catch(err){ console.error(err); dataInfoEl.textContent=`Erro ao carregar: ${err.message}`; }
    });

    function parseCSV(file){ return new Promise((resolve,reject)=>{ Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:(res)=>resolve(res.data),error:(err)=>reject(err)}); }); }
    async function parseExcel(file){ const data=await file.arrayBuffer(); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws,{defval:''}); return json.filter(r=>Object.values(r).some(v=>v!==''&&v!=null)); }

    // === NOVO: geocodificação incremental com progresso visível ===
    async function prepareAndGeocodeIncremental(rows, originalName){
      const keys=Object.keys(rows[0]||{}).map(k=>k.trim());
      const kCliente=findKey(keys,['Cliente','cliente','Nome','nome']);
      const kCidade=findKey(keys,['Cidade do cliente','Cidade','cidade']);
      const kUF=findKey(keys,['UF','uf','Uf']);
      const kStatus=findKey(keys,['Status cliente','status','Status']);
      const kClass=findKey(keys,['Classificação','Classificacao','classificacao']);
      const kTime=findKey(keys,['Time','time','Equipe','equipe']);
      const kLat=findKey(keys,['lat','latitude','Latitude','LAT']);
      const kLng=findKey(keys,['lng','lon','longitude','Longitude','LNG','LONG']);

      uniqueCavaleiros.clear(); uniqueClasses.clear(); uniqueStatuses.clear();
      rows.forEach(r=>{ uniqueCavaleiros.add(norm(r[kTime])||NULL_CAVALEIRO); uniqueClasses.add(norm(r[kClass])||NULL_CLASS); uniqueStatuses.add(norm(r[kStatus])||NULL_STATUS); });
      selCavaleiros=new Set(uniqueCavaleiros); selClasses=new Set(uniqueClasses); selStatuses=new Set(uniqueStatuses);
      renderFilterLists(); renderLegend();

      points=[]; augmentedRows=[]; clusters.clearLayers(); countInfoEl.textContent='0 clientes visíveis';

      // Se já houver lat/lng, usa direto e habilita export
      if(kLat && kLng){
        rows.forEach(r=>{
          const lat=Number(r[kLat]); const lng=Number(r[kLng]); const cidade=norm(r[kCidade]); const uf=norm(r[kUF]);
          const p={ nome:norm(r[kCliente])||'', cidade, uf, status:(norm(r[kStatus])||NULL_STATUS), classificacao:(norm(r[kClass])||NULL_CLASS), cavaleiro:(norm(r[kTime])||NULL_CAVALEIRO), lat:isFinite(lat)?lat:null, lng:isFinite(lng)?lng:null };
          if(isFinite(lat)&&isFinite(lng)) points.push(p);
          const out={...r, latitude: isFinite(lat)?lat:'', longitude: isFinite(lng)?lng:''}; augmentedRows.push(out);
        });
        geoStatsEl.textContent=`Coordenadas presentes na base | ${points.length} pontos`;
        updateMarkers(true);
        enableExport(originalName);
        return;
      }

      // Monta mapa cidade->linhas
      const cityRows = new Map();
      rows.forEach(r=>{ const cidade=norm(r[kCidade]); const uf=norm(r[kUF]); if(!cidade||!uf) return; const ck=`${cidade}|${uf}`; if(!cityRows.has(ck)) cityRows.set(ck,[]); cityRows.get(ck).push(r); });
      const totalCities = cityRows.size; let done=0; let fail=0; const everyN=10; // atualiza markers a cada 10 cidades para performance
      geoStatsEl.textContent=`${totalCities} cidades únicas para geocodificar…`;

      for(const [ck, list] of cityRows){
        const [cidade, uf] = ck.split('|');
        const coords = await geocodeCityUF(cidade, uf);
        if(!coords){ fail++; list.forEach(r=>{ const out={...r, latitude:'', longitude:''}; augmentedRows.push(out); }); }
        else {
          list.forEach(r=>{
            const status=(norm(r[kStatus])||NULL_STATUS), classificacao=(norm(r[kClass])||NULL_CLASS), cavaleiro=(norm(r[kTime])||NULL_CAVALEIRO);
            const p={ nome:norm(r[kCliente])||'', cidade, uf, status, classificacao, cavaleiro, lat:coords.lat, lng:coords.lon };
            points.push(p);
            const out={...r, latitude: coords.lat, longitude: coords.lon}; augmentedRows.push(out);
          });
        }
        done++;
        const pct = Math.round((done/totalCities)*100);
        barEl.style.width = pct+'%';
        geoStatsEl.textContent = `Geocodificado: ${done}/${totalCities} | falhas: ${fail} | pontos: ${points.length}`;
        if(done===1 || done % everyN === 0) updateMarkers(done===1); // incremental
      }

      // Finaliza
      updateMarkers(true);
      enableExport(originalName);
    }

    function enableExport(originalName){
      exportCsvBtn.disabled=false; exportXlsxBtn.disabled=false;
      exportCsvBtn.onclick=()=> downloadCSV(augmentedRows, originalName.replace(/\.[^.]+$/, '')+"_latlng.csv");
      exportXlsxBtn.onclick=()=> downloadXLSX(augmentedRows, originalName.replace(/\.[^.]+$/, '')+"_latlng.xlsx");
    }

    function downloadCSV(rows, filename){ const cols = Object.keys(rows[0]||{}); const csv = [cols.join(',')].concat(rows.map(r=> cols.map(c=> escapeCsv(String(r[c]??''))).join(','))).join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function escapeCsv(v){ if(/[",\n]/.test(v)) return '"'+v.replace(/"/g,'""')+'"'; return v; }
    function downloadXLSX(rows, filename){ const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Base'); XLSX.writeFile(wb, filename); }

    function findKey(keys, candidates){ const normKey=k=>k.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim(); const lc=keys.map(normKey); for(const c of candidates){ const nc=normKey(c); const i=lc.indexOf(nc); if(i>=0) return keys[i]; } return null; }

    resetBtn.addEventListener('click',()=>{ setAll(listCavaleiroEl, selCavaleiros, uniqueCavaleiros, true); setAll(listClassEl, selClasses, uniqueClasses, true); setAll(listStatusEl, selStatuses, uniqueStatuses, true); });
  </script>
</body>
</html>
